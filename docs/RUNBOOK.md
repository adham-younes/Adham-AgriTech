# Runbook

## On-call Quick Checklist
1. تأكّد أن الخدمة متاحة عبر `system-health` وأن الحالة `ok`.
2. راجع آخر تشغيل للوظائف الأربع: `fetch-weather-daily`، `fetch-ndvi`، `generate-report-monthly`، `system-health`.
3. نفّذ أوامر التشخيص السريعة (Latency + Error rate + أحدث السجلات).
4. تحقّق من صحة البيانات الجديدة (التغطية الزمنية، القيم الشاذة، عدم وجود تكرار).
5. إن كان التأثير واسعًا أو البيانات غير موثوقة، نفّذ rollback وفق القسم أدناه.
6. وثّق الحادثة: السبب الجذري، الإجراءات، وقت الاستعادة، والخطوات الوقائية.

---

## نقاط النهاية (Edge Functions)
- فحص النظام: `/functions/v1/system-health`
- جلب الطقس اليومي: `/functions/v1/fetch-weather-daily`
- جلب NDVI: `/functions/v1/fetch-ndvi`
- توليد التقرير الشهري: `/functions/v1/generate-report-monthly`

> أمثلة الأوامر أدناه تفترض ضبط:
>
> - `BASE_URL` مثل: `https://<project-ref>.supabase.co`
> - `SERVICE_ROLE_KEY` بصلاحيات التشغيل/الصيانة

```bash
export BASE_URL="https://<project-ref>.supabase.co"
export SERVICE_ROLE_KEY="<service-role-key>"
```

---

## أوامر التشخيص (Diagnostics)

### 1) فحص الصحة العامة
```bash
curl -sS -X POST "$BASE_URL/functions/v1/system-health" \
  -H "Authorization: Bearer $SERVICE_ROLE_KEY" \
  -H "Content-Type: application/json" | jq .
```

### 2) قياس زمن الاستجابة لوظيفة محددة
```bash
time curl -sS -o /tmp/fn.out -w "HTTP %{http_code}\n" \
  -X POST "$BASE_URL/functions/v1/fetch-weather-daily" \
  -H "Authorization: Bearer $SERVICE_ROLE_KEY" \
  -H "Content-Type: application/json"
cat /tmp/fn.out | jq .
```

### 3) تتبع الأخطاء من السجلات (عند توفر CLI)
```bash
# مثال: آخر 100 سطر لسجل الوظيفة
supabase functions logs fetch-weather-daily --limit 100
supabase functions logs fetch-ndvi --limit 100
supabase functions logs generate-report-monthly --limit 100
supabase functions logs system-health --limit 100
```

### 4) إعادة تشغيل يدوي سريع
```bash
curl -sS -X POST "$BASE_URL/functions/v1/fetch-weather-daily" \
  -H "Authorization: Bearer $SERVICE_ROLE_KEY" \
  -H "Content-Type: application/json" | jq .

curl -sS -X POST "$BASE_URL/functions/v1/fetch-ndvi" \
  -H "Authorization: Bearer $SERVICE_ROLE_KEY" \
  -H "Content-Type: application/json" | jq .

curl -sS -X POST "$BASE_URL/functions/v1/generate-report-monthly" \
  -H "Authorization: Bearer $SERVICE_ROLE_KEY" \
  -H "Content-Type: application/json" | jq .
```

---

## Playbooks تفصيلية لكل وظيفة

### A) `fetch-weather-daily`
**الهدف:** جلب بيانات الطقس اليومية من المصدر الخارجي وتخزينها.

**متى نتدخل؟**
- فشل الوظيفة (HTTP 5xx / timeout).
- بيانات يوم ناقصة أو مكررة.
- قيم غير منطقية (مثل حرارة خارج النطاق المعتاد بشكل واضح).

**خطوات الاستجابة:**
1. نفّذ `system-health` وتأكد أن الاعتماديات الخارجية متاحة.
2. نفّذ الوظيفة يدويًا وتحقق من كود الاستجابة والمخرجات.
3. راجع السجلات للرسائل المتعلقة بالمصدر الخارجي (rate limit / auth / schema).
4. عند نجاح التنفيذ اليدوي، راقب إدراج البيانات للتاريخ المستهدف.
5. إن استمر الفشل: أوقف الجدولة مؤقتًا، وصعّد للحالة إلى مالك التكامل الخارجي.

**معايير الإغلاق:**
- آخر تشغيل ناجح.
- اكتمال بيانات اليوم المستهدف بدون تكرار.
- لا توجد أخطاء حرجة في آخر نافذة مراقبة.

### B) `fetch-ndvi`
**الهدف:** جلب مؤشر NDVI وتحديث بيانات الحقول/المناطق.

**متى نتدخل؟**
- تأخر التحديث عن الجدول المتوقع.
- فجوات مكانية أو زمنية في القيم.
- قيم NDVI خارج المجال المتوقع (عادة بين -1 و 1).

**خطوات الاستجابة:**
1. تحقق من صحة مدخلات الوظيفة (التواريخ/المناطق).
2. شغّل الوظيفة يدويًا واحتفظ بمخرجات التنفيذ.
3. راجع السجلات لأي فشل في المصدر (quota, auth, parsing).
4. نفّذ تحقق جودة البيانات (النطاق، الاكتمال، التكرار).
5. عند وجود انحرافات كبيرة، علّق الاعتماد على NDVI في التقارير لحين الإصلاح.

**معايير الإغلاق:**
- وصول بيانات NDVI لجميع النطاقات المطلوبة.
- اجتياز فحوص الجودة الأساسية.

### C) `generate-report-monthly`
**الهدف:** بناء التقرير الشهري من البيانات المجمعة (طقس + NDVI + مؤشرات مشتقة).

**متى نتدخل؟**
- عدم توليد التقرير في الوقت المحدد.
- تقرير فارغ/ناقص.
- اختلاف واضح عن الشهر السابق بدون سبب تشغيلي معروف.

**خطوات الاستجابة:**
1. تحقق أن `fetch-weather-daily` و `fetch-ndvi` مكتملتان للفترة الشهرية.
2. شغّل `generate-report-monthly` يدويًا لنفس الشهر.
3. افحص السجلات لأي أخطاء تجميع أو فشل كتابة.
4. قارن مؤشرات التقرير الجديد بآخر تقرير صحيح (sanity check).
5. انشر التقرير فقط بعد تأكيد الاتساق.

**معايير الإغلاق:**
- تم توليد التقرير للشهر الصحيح.
- تحقق الجودة ناجح (لا نقص بيانات/لا تضخيم واضح).

### D) `system-health`
**الهدف:** فحص حيوية النظام والاعتماديات الداخلية/الخارجية.

**متى نتدخل؟**
- حالة `degraded` أو `down`.
- ارتفاع مفاجئ في زمن الاستجابة.
- تناقض بين الصحة العامة ونجاح الوظائف الفرعية.

**خطوات الاستجابة:**
1. إعادة تنفيذ `system-health` أكثر من مرة لتأكيد أن المشكلة ليست عابرة.
2. فحص وظائف النظام الأربع يدويًا لتحديد موضع العطل.
3. التحقق من الشبكة/المفاتيح/الحصص على الخدمات الخارجية.
4. توثيق المكوّن المتأثر وتفعيل خطة rollback عند الحاجة.

**معايير الإغلاق:**
- عودة الحالة إلى `ok`.
- نجاح تشغيل تجريبي للوظائف الحرجة.

---

## التحقق من صحة البيانات بعد الاسترداد

نفّذ الفحوص التالية بعد أي إعادة تشغيل يدوي أو معالجة حادثة:

1. **الاكتمال الزمني:**
   - وجود سجلات لكل فترة متوقعة (يومي/شهري).
2. **الاكتمال المكاني (إن وجد):**
   - جميع الحقول/المناطق المطلوبة مغطاة.
3. **غياب التكرار:**
   - عدم وجود سجلات مكررة لنفس المفتاح المنطقي (date + location + source).
4. **صحة النطاق:**
   - NDVI ضمن المجال المنطقي.
   - مؤشرات الطقس ضمن حدود فيزيائية معقولة.
5. **اتساق المشتقات:**
   - التقرير الشهري يعكس نفس إجماليات المصادر بعد إعادة الحساب.

مثال SQL تشخيصي (عدّل أسماء الجداول/الأعمدة حسب المخطط):
```sql
-- تحقق تكرار بيانات طقس
SELECT date, location_id, COUNT(*)
FROM weather_daily
GROUP BY 1,2
HAVING COUNT(*) > 1;

-- تحقق نطاق NDVI
SELECT MIN(ndvi) AS min_ndvi, MAX(ndvi) AS max_ndvi
FROM ndvi_daily
WHERE date >= CURRENT_DATE - INTERVAL '30 days';
```

---

## إجراءات Rollback

> الهدف من rollback هو **استعادة الثقة بالبيانات** بسرعة وتقليل أثر الحادثة.

### متى نفعّل Rollback؟
- إدخال بيانات فاسدة/ناقصة على نطاق واسع.
- عدم القدرة على إصلاح المشكلة ضمن نافذة تشغيل مقبولة.
- فشل متكرر بعد أكثر من محاولة استرداد.

### خطوات Rollback القياسية
1. **إيقاف التريغر/الجدولة مؤقتًا** للوظيفة المتأثرة لمنع تفاقم الضرر.
2. **تحديد نافذة التأثير** (من وقت X إلى Y) والكيانات المتأثرة.
3. **عزل البيانات الخاطئة**:
   - حذف/وسم السجلات المتأثرة (حسب سياسة الفريق).
4. **استعادة آخر نسخة موثوقة**:
   - من snapshot/backup أو إعادة تشغيل pipeline من نقطة سليمة.
5. **إعادة التحقق** باستخدام قائمة فحوص الجودة أعلاه.
6. **إعادة تفعيل الجدولة** تدريجيًا مع مراقبة مكثفة.
7. **توثيق RCA** وخطة منع التكرار.

### Rollback خاص بـ `generate-report-monthly`
- إلغاء نشر التقرير المعيب.
- إعادة نشر آخر تقرير صحيح.
- إعادة التوليد بعد إصلاح المصدر والتحقق الكامل.

---

## ملاحظات تشغيلية
- يُفضّل حفظ ناتج كل تشغيل يدوي في تذكرة الحادثة.
- لا تعتمد على نجاح HTTP فقط؛ تحقق دائمًا من جودة البيانات المخزنة.
- عند الشك، فضّل إيقاف النشر/الجدولة مؤقتًا على تمرير بيانات غير موثوقة.
